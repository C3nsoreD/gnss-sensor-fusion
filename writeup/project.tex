\documentclass{article}

\usepackage{amsmath}
\usepackage{mathtools}
\usepackage{amsthm}
\usepackage{amssymb}
\usepackage{bbm}
\usepackage{fancyhdr}
% \usepackage{listings}
\usepackage{cite}
\usepackage{graphicx}
\usepackage{enumitem}
\usepackage{courier}
\usepackage{gensymb}
\usepackage[pdftex,colorlinks=true, urlcolor = blue]{hyperref}
\usepackage{algorithm}
\usepackage{algpseudocode}
\usepackage{algorithmic}
\usepackage{caption}


\oddsidemargin 0in \evensidemargin 0in
\topmargin -0.5in \headheight 0.25in \headsep 0.25in
\textwidth 6.5in \textheight 9in
\parskip 6pt \parindent 0in \footskip 20pt

% set the header up
\fancyhead{}
\fancyhead[L]{Stanford Aeronautics \& Astronautics}
\fancyhead[R]{Winter 2020}

%%%%%%%%%%%%%%%%%%%%%%%%%%
\renewcommand\headrulewidth{0.4pt}
\setlength\headheight{15pt}

\usepackage{xparse}
\NewDocumentCommand{\codeword}{v}{%
\texttt{\textcolor{blue}{#1}}%
}

\usepackage{xcolor}
\setlength{\parindent}{0in}

\title{AA 272C: Global Positioning Systems \\ Problem Set 3}
\author{Name: Derek Knowles      \\ SUID: derekck}
\date{}

\begin{document}

\maketitle
\pagestyle{fancy}
\section*{Algorithm Sensor Fusion}


\algnewcommand{\Inputs}[1]{%
  \State \textbf{Inputs:}
}
\algnewcommand{\Initialize}[1]{%
  \State \textbf{Initialize:}
}

\algnewcommand{\Predict}[1]{%
  \State \textbf{Predict:}
}

\algnewcommand{\UpdateGNSS}[1]{\State\textbf{Update GNSS:}}
\algnewcommand{\UpdateBaro}[1]{\State\textbf{Update Barometer:}}

\algdef{SE}[SUBALG]{Indent}{EndIndent}{}{\algorithmicend\ }%
\algtext*{Indent}
\algtext*{EndIndent}

\begin{algorithm}
	\caption{Sensor Fusion EKF}

	\begin{algorithmic}[1]
        \Inputs{}
            \Indent
            \State GNSS pseudoranges
            \State Satellite positions
            \State IMU odometry
            \State barometer measurements
            \EndIndent
        \Initialize{}
            \Indent
            \State $\mathbf{T} \leftarrow $ concatenated and sorted timesteps
            \EndIndent
		\For {$t \in \mathbf{T}$}
			\If {odometry exists at $t$}
                \Predict{}
                \Indent
                \State $ v_t \leftarrow $ imu odometry
                \State $ \hat{\mu}_{t\mid t-1} = F \hat{\mu}_{t-1\mid t-1} + B v_t$
                \State $ P_{t\mid t-1} = F_tP_{t-1\mid t-1}F^T_t+Q$
                \EndIndent
			\EndIf
            \If {GNSS exists at $t$}
                \UpdateGNSS{}
                \Indent
                \State $z_t \leftarrow$ GNSS measurements
                \State $\tilde{y}_t = z_t - h(\hat{\mu}_{t\mid t-1})$
                \State $K_t = P_{t\mid t-1} H^T_t(R + H_tP_{t\mid t-1}H^T_t)^{-1}$
                \State $ \hat{\mu}_{t\mid t} =  \hat{\mu}_{t\mid t-1} +K_t \tilde{y}_t$
                \State $ P_{t\mid t} = (I-K_tH_t)P_{t\mid t-1}(I-K_tH_t)^T+K_tRK_t^T$
                \EndIndent
			\EndIf
            \If {Barometer exists at $t$}
                \UpdateBaro{}
                \Indent
                \State $z_t \leftarrow$ barometer measurements
                \State $\tilde{y}_t = z_t - h(\hat{\mu}_{t\mid t-1})$
                \State $K_t = P_{t\mid t-1} H^T_t(R + H_tP_{t\mid t-1}H^T_t)^{-1}$
                \State $ \hat{\mu}_{t\mid t} =  \hat{\mu}_{t\mid t-1} +K_t \tilde{y}_t$
                \State $ P_{t\mid t} = (I-K_tH_t)P_{t\mid t-1}(I-K_tH_t)^T+K_tRK_t^T$
                \EndIndent
			\EndIf
		\EndFor
	\end{algorithmic}
\end{algorithm}


\section*{EKF Model Update}

    For the state:
    $$ \hat{\mu} =
    \begin{bmatrix}
        x \\
        y \\
        z \\
        \dot{x} \\
        \dot{y} \\
        \dot{z}
    \end{bmatrix}
    $$
    For the predict step, I will use:
    $$ \hat{\mu}_{t\mid t-1} = F \hat{\mu}_{t-1\mid t-1} $$
    $$ \hat{\mu}_{t\mid t-1} =
    \begin{bmatrix}
        1 & 0 & 0 & \Delta t & 0 & 0 \\
        0 & 1 & 0 & 0 & \Delta t & 0 \\
        0 & 0 & 1 & 0 & 0 & \Delta t \\
        0 & 0 & 0 & 1 & 0 & 0 \\
        0 & 0 & 0 & 0 & 1 & 0 \\
        0 & 0 & 0 & 0 & 0 & 1 \\
    \end{bmatrix}
    \begin{bmatrix}
        x \\
        y \\
        z \\
        \dot{x} \\
        \dot{y} \\
        \dot{z}
    \end{bmatrix}

    For Q, I will use
    $$ \sigma = 0.03 km/h * \frac{1000m}{1km} * \frac{1 h}{3600s} * dt$$
    $$Q =
    \begin{bmatrix}
        \sigma^2 & 0 & 0\\
        0 & \sigma^2 & 0\\
        0 & 0 & \sigma^2\\
    \end{bmatrix}
    $$
    For the update step, I will use
    $$ h =
    \begin{bmatrix}
    \sqrt{(x_1-x)^2+(y_1-y)^2+(z_1-z)^2}} \\
    \sqrt{(x_2-x)^2+(y_2-y)^2+(z_2-z)^2}} \\
    \sqrt{(x_3-x)^2+(y_3-y)^2+(z_3-z)^2}} \\
    \sqrt{(x_4-x)^2+(y_4-y)^2+(z_4-z)^2}} \\
    \sqrt{(x_5-x)^2+(y_5-y)^2+(z_5-z)^2}} \\
    \sqrt{(x_6-x)^2+(y_6-y)^2+(z_6-z)^2}}
    \end{bmatrix}
    $$
    $$H =
    \begin{bmatrix}
        \frac{-(x_1-x)}{\sqrt{(x_1-x)^2+(y_1-y)^2+(z_1-z)^2}} & \frac{-(y_1-y)}{\sqrt{(x_1-x)^2+(y_1-y)^2+(z_1-z)^2}} &
        \frac{-(z_1-z)}{\sqrt{(x_1-x)^2+(y_1-y)^2+(z_1-z)^2}}
        \\
        \frac{-(x_2-x)}{\sqrt{(x_2-x)^2+(y_2-y)^2+(z_2-z)^2}} & \frac{-(y_2-y)}{\sqrt{(x_2-x)^2+(y_2-y)^2+(z_2-z)^2}} &
        \frac{-(z_2-z)}{\sqrt{(x_2-x)^2+(y_2-y)^2+(z_2-z)^2}}
        \\
        \frac{-(x_3-x)}{\sqrt{(x_3-x)^2+(y_3-y)^2+(z_3-z)^2}} & \frac{-(y_3-y)}{\sqrt{(x_3-x)^2+(y_3-y)^2+(z_3-z)^2}} &
        \frac{-(z_3-z)}{\sqrt{(x_3-x)^2+(y_3-y)^2+(z_3-z)^2}}
        \\
        \frac{-(x_4-x)}{\sqrt{(x_4-x)^2+(y_4-y)^2+(z_4-z)^2}} & \frac{-(y_4-y)}{\sqrt{(x_4-x)^2+(y_4-y)^2+(z_4-z)^2}} &
        \frac{-(z_4-z)}{\sqrt{(x_4-x)^2+(y_4-y)^2+(z_4-z)^2}}
        \\
        \frac{-(x_5-x)}{\sqrt{(x_5-x)^2+(y_5-y)^2+(z_5-z)^2}} & \frac{-(y_5-y)}{\sqrt{(x_5-x)^2+(y_5-y)^2+(z_5-z)^2}} &
        \frac{-(z_5-z)}{\sqrt{(x_5-x)^2+(y_5-y)^2+(z_5-z)^2}}
        \\
        \frac{-(x_6-x)}{\sqrt{(x_6-x)^2+(y_6-y)^2+(z_6-z)^2}} & \frac{-(y_6-y)}{\sqrt{(x_6-x)^2+(y_6-y)^2+(z_6-z)^2}} &
        \frac{-(z_6-z)}{\sqrt{(x_6-x)^2+(y_6-y)^2+(z_6-z)^2}}
        \\
    \end{bmatrix}
    $$ \sigma = 8m$$
    $$R =
    \begin{bmatrix}
        \sigma^2 & 0 & 0 & 0 & 0 & 0\\
        0 & \sigma^2 & 0 & 0 & 0 & 0\\
        0 & 0 & \sigma^2 & 0 & 0 & 0\\
        0 & 0 & 0 & \sigma^2 & 0 & 0\\
        0 & 0 & 0 & 0 & \sigma^2 & 0\\
        0 & 0 & 0 & 0 & 0 & \sigma^2\\
    \end{bmatrix}
    $$




\end{enumerate}

\end{document}
